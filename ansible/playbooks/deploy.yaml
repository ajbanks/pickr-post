---
## This playbook deploys the topic-tweet repo to a target host
## Usage: ansible-playbook ./playbooks/deploy.yaml -i inventory.yaml \
##              --extra-vars "target=<target> deploy_user=<username>"
- hosts: "{{ target }}"
  vars:
    GIT_REPO: "git@github.com:pickrsocial/topic-tweet.git"
    GIT_BRANCH: main
    dotenv: "/home/{{ deploy_user }}/.env"
    dest: "/home/{{ deploy_user }}/topic-tweet"
  tasks:
    - name: Clear tmp
      file:
        path: "/tmp/topic-tweet"
        state: absent
      become: yes
    - name: Clone repo
      git:
        repo: "{{ GIT_REPO }}"
        version: "{{ GIT_BRANCH }}"
        dest: "/tmp/topic-tweet"
        accept_hostkey: yes
        depth: 1
      become: no
    - name: Delete existing repo
      file:
        path: "{{ dest }}"
        state: absent
      become: yes
    - name: Move repo
      command:
        cmd: "mv /tmp/topic-tweet {{ dest }}"
        creates: "{{ dest }}"
      become: yes
    - name: Install required modules
      command:
        cmd: "/home/{{ deploy_user }}/venv/bin/pip install -r {{ dest }}/requirements.txt"
      become: yes
    - name: chown directory
      file:
        path: "{{ dest }}"
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        recurse: yes
      become: yes
    - name: copy dotenv
      command:
        "cp {{ dotenv }} {{ dest }}"
      become: yes

- hosts: worker
  tasks:
    - name: Restart celery
      systemd:
        name: celery.service
        state: restarted
      become: yes

- hosts: web
  tasks:
    - name: Restart services
      systemd:
        name: "{{ item }}"
        state: restarted
      become: yes
      with_items:
        - gunicorn.service
        - celery.service
        - celerybeat.service
